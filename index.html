<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Earthquake Victims Request</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fefefe; color:#333; }
    header { background:#e74c3c; color:white; text-align:center; padding:60px 20px; }
    header h1 { font-size:2.5rem; margin-bottom:10px; }
    section { padding:40px 20px; max-width:1100px; margin:auto; }
    .card { background:white; padding:25px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    input, textarea, select, button { width:100%; padding:12px; margin:10px 0; font-size:16px; border-radius:5px; }
    button { background:#e74c3c; color:white; border:none; cursor:pointer; font-weight:bold; }
    button:hover { background:#c0392b; }
    #landmarkMap { height:300px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; }
  </style>
</head>
<body>
  <header>
    <h1>Bogo Earthquake Relief – Your Help, Their Hope</h1>
  </header>

  <section>
    <div class="card">
      <h2>Request Relief Assistance</h2>
      <form id="requestForm">
        <label for="name">Full Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="municipality">Municipality:</label>
        <select id="municipality" name="municipality" required>
          <option value="">-- Loading municipalities --</option>
        </select>

        <label for="barangay">Barangay:</label>
        <select id="barangay" name="barangay" required disabled>
          <option value="">-- Select municipality first --</option>
        </select>

        <label for="landmark">Closest Landmark:</label>
        <input type="text" id="landmark" name="landmark" placeholder="E.g., Bogo City Hall" required>

        <label for="landmarkMap">Show on Map (Click to Select Location):</label>
        <div id="landmarkMap"></div>

        <label for="status">Status (Safe, Injured, Needs Medical Help):</label>
        <input type="text" id="status" name="status" required>

        <label for="supplies">Requested Supplies:</label>
        <textarea id="supplies" name="supplies" rows="4" required></textarea>

        <button type="submit">Submit Request</button>
      </form>
    </div>
  </section>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase + Custom JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBWt99TXD-yWrlDuU6TPEZVMPrDQGV3Y-w",
      authDomain: "emergency-response-927b4.firebaseapp.com",
      databaseURL: "https://emergency-response-927b4-default-rtdb.firebaseio.com",
      projectId: "emergency-response-927b4",
      storageBucket: "emergency-response-927b4.appspot.com",
      messagingSenderId: "764143976759",
      appId: "1:764143976759:web:340b2fa2834b6406439ab2",
      measurementId: "G-Z0479KDD64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Populate municipalities and barangays
    function populateMunicipalities(locations) {
      const municipalitySelect = document.getElementById("municipality");
      const barangaySelect = document.getElementById("barangay");

      municipalitySelect.innerHTML = '<option value="">-- Select municipality --</option>';
      Object.keys(locations).forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        option.textContent = m;
        municipalitySelect.appendChild(option);
      });

      barangaySelect.innerHTML = '<option value="">-- Select municipality first --</option>';
      barangaySelect.disabled = true;

      municipalitySelect.addEventListener("change", () => {
        const selectedMun = municipalitySelect.value;
        barangaySelect.innerHTML = "";
        if (!selectedMun) {
          barangaySelect.disabled = true;
          barangaySelect.innerHTML = '<option value="">-- Select municipality first --</option>';
          return;
        }
        (locations[selectedMun] || []).forEach(b => {
          const option = document.createElement("option");
          option.value = b;
          option.textContent = b;
          barangaySelect.appendChild(option);
        });
        barangaySelect.disabled = false;
      });
    }

    // Load Cebu municipalities and barangays
    async function loadCebuMap() {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/flores-jacob/philippine-regions-provinces-cities-municipalities-barangays/master/philippine_provinces_cities_municipalities_and_barangays_2019v2.json"
        );
        const allData = await res.json();
        let cebuData = null;
        for (const regionKey in allData) {
          const region = allData[regionKey];
          if (!region.province_list) continue;
          if (region.province_list["CEBU"]) {
            cebuData = region.province_list["CEBU"];
            break;
          }
        }
        if (!cebuData) return console.error("Cebu province not found");
        const locations = {};
        if (cebuData.municipality_list) {
          for (const mun in cebuData.municipality_list) {
            locations[mun] = cebuData.municipality_list[mun].barangay_list || [];
          }
        }
        if (cebuData.city_list) {
          for (const city in cebuData.city_list) {
            locations[city] = cebuData.city_list[city].barangay_list || [];
          }
        }
        populateMunicipalities(locations);
      } catch (err) {
        console.error("Failed to load Cebu map:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadCebuMap();

      // Initialize Leaflet map
      const landmarkMap = L.map('landmarkMap').setView([10.3157, 123.8854], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(landmarkMap);

      let landmarkMarker = null;

      // Click map to select location
      landmarkMap.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        const description = prompt("Enter landmark description (optional):");
        if (landmarkMarker) landmarkMap.removeLayer(landmarkMarker);
        landmarkMarker = L.marker([lat, lng]).addTo(landmarkMap);
        landmarkMarker.bindPopup(`
          ${description || "Selected Location"} <br>
          <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">Open in Google Maps</a>
        `).openPopup();
        document.getElementById("landmark").value = description ? `${description} (${lat}, ${lng})` : `${lat}, ${lng}`;
      });

      // Form submission
      const form = document.getElementById("requestForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector("button");
        submitButton.disabled = true;

        const name = document.getElementById("name").value;
        const municipality = document.getElementById("municipality").value;
        const barangay = document.getElementById("barangay").value;
        const landmark = document.getElementById("landmark").value;
        const status = document.getElementById("status").value;
        const supplies = document.getElementById("supplies").value;

        if (!name || !municipality || !barangay || !landmark || !status || !supplies) {
          alert("Please fill all fields.");
          submitButton.disabled = false;
          return;
        }

        try {
          const date = new Date().toISOString().split('T')[0];
          await push(ref(db, "requests"), { name, municipality, barangay, landmark, status, supplies, date });
          alert("Request submitted successfully!");
          form.reset();
          document.getElementById("barangay").disabled = true;
          if (landmarkMarker) landmarkMap.removeLayer(landmarkMarker);
        } catch (err) {
          alert("Failed to submit request. Please try again.");
          console.error(err);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
