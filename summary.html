<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bogo Relief Summary</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWt99TXD-yWrlDuU6TPEZVMPrDQGV3Y-w",
      authDomain: "emergency-response-927b4.firebaseapp.com",
      projectId: "emergency-response-927b4",
      storageBucket: "emergency-response-927b4.appspot.com",
      messagingSenderId: "764143976759",
      appId: "1:764143976759:web:340b2fa2834b6406439ab2",
      measurementId: "G-Z0479KDD64",
      databaseURL: "https://emergency-response-927b4-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let allRequests = [];

    // Load requests from Firebase
    const requestsRef = ref(db, "requests");
    onValue(requestsRef, (snapshot) => {
      allRequests = [];
      snapshot.forEach(child => {
        allRequests.push(child.val());
      });
      populateBarangayFilter();
      renderTable(allRequests);
    });

    function renderTable(data) {
      const tbody = document.querySelector("#summaryTable tbody");
      tbody.innerHTML = "";
      data.forEach(d => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.name}</td>
          <td>${d.municipality}</td>
          <td>${d.barangay}</td>
          <td>${d.status}</td>
          <td>${d.supplies}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function populateBarangayFilter() {
      const barangaySelect = document.getElementById("filterBarangay");
      const barangays = [...new Set(allRequests.map(r => r.barangay))].sort();
      barangaySelect.innerHTML = '<option value="">-- All Barangays --</option>';
      barangays.forEach(b => {
        const option = document.createElement("option");
        option.value = b;
        option.textContent = b;
        barangaySelect.appendChild(option);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sortSelect = document.getElementById("sortBy");
      const barangaySelect = document.getElementById("filterBarangay");

      function applyFilters() {
        let filtered = [...allRequests];
        const sortKey = sortSelect.value;
        const barangayFilter = barangaySelect.value;

        if (barangayFilter) {
          filtered = filtered.filter(r => r.barangay === barangayFilter);
        }
        if (sortKey) {
          filtered.sort((a, b) => a[sortKey].localeCompare(b[sortKey]));
        }
        renderTable(filtered);
      }

      sortSelect.addEventListener("change", applyFilters);
      barangaySelect.addEventListener("change", applyFilters);

      // Export to Excel (CSV)
      document.getElementById("exportExcel").addEventListener("click", () => {
        const currentRows = document.querySelectorAll("#summaryTable tbody tr");
        if (currentRows.length === 0) return alert("No data to export");

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Municipality,Barangay,Status,Supplies\n";

        currentRows.forEach(row => {
          const cols = Array.from(row.querySelectorAll("td")).map(td => `"${td.textContent.replace(/"/g,'""')}"`);
          csvContent += cols.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "bogo_relief_summary.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f8f9fa; color:#333; }
    header { background:#d63031; color:white; text-align:center; padding:20px; }
    section { padding:20px; max-width:900px; margin:auto; }
    .card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border:1px solid #ccc; text-align:left; }
    select, button { padding:8px; margin:10px 5px 10px 0; border-radius:5px; border:1px solid #ccc; font-size:14px; }
    button { background:#d63031; color:white; border:none; cursor:pointer; }
    button:hover { background:#b02a2a; }
  </style>
</head>
<body>
  <header>
    <h1>Bogo Relief Requests Summary</h1>
    <p>View, filter by barangay, sort, and export relief requests.</p>
  </header>

  <section>
    <div class="card">
      <label for="sortBy">Sort by:</label>
      <select id="sortBy">
        <option value="">-- None --</option>
        <option value="municipality">Municipality</option>
        <option value="barangay">Barangay</option>
      </select>

      <label for="filterBarangay">Filter by Barangay:</label>
      <select id="filterBarangay">
        <option value="">-- All Barangays --</option>
      </select>

      <button id="exportExcel">Export to Excel</button>

      <table id="summaryTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Municipality</th>
            <th>Barangay</th>
            <th>Status</th>
            <th>Supplies</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</body>
</html>
